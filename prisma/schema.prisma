// Prisma Schema - Clean Architecture Domain Models
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum ActionType {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED
  SESSION_REFRESH
  
  // User Management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_STATUS_CHANGED
  
  // Profile Management
  PROFILE_VIEWED
  PROFILE_UPDATED
  PASSWORD_CHANGED
  
  // Department Management
  DEPARTMENT_CREATED
  DEPARTMENT_UPDATED
  DEPARTMENT_DELETED
  
  // System Actions
  SYSTEM_ACCESS
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  
  // Data Operations
  DATA_EXPORTED
  DATA_IMPORTED
  
  // Other
  OTHER
}

// =============================================================================
// DOMAIN: USER
// =============================================================================

model User {
  id                String     @id @default(uuid())
  keycloakId        String     @unique @map("keycloak_id")
  
  // Personal Information
  email             String     @unique
  peaEmail          String?    @map("pea_email")
  firstName         String     @map("first_name")
  lastName          String     @map("last_name")
  phoneNumber       String?    @map("phone_number")
  
  // Position Information
  position          String?
  positionShort     String?    @map("position_short")
  positionLevel     String?    @map("position_level")
  
  // Department Relation
  departmentId      String?    @map("department_id")
  department        Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  // Status & Metadata
  status            UserStatus @default(ACTIVE)
  lastLoginAt       DateTime?  @map("last_login_at")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  
  // Relations
  actionLogs        UserActionLog[] @relation("UserActions")
  targetedActions   UserActionLog[] @relation("TargetUserActions")
  userRoles         UserRole[]
  
  @@map("users")
  @@index([keycloakId])
  @@index([email])
  @@index([departmentId])
  @@index([status])
  files Files[]
  offSiteWorks OffSiteWork[]
  expenseClaims          ExpenseClaim[] @relation("ExpenseClaimUser")
  createdExpenseClaims   ExpenseClaim[] @relation("ExpenseClaimCreator")
  
  monthlyRequestsCollection MonthlyRequestCollection[]
  signatures Signature[]
}

// =============================================================================
// DOMAIN: DEPARTMENT
// =============================================================================

model Department {
  id                String     @id @default(uuid())
  
  // Department Information
  name              String     @unique
  shortName         String?    @unique @map("short_name")
  description       String?
  
  // Hierarchy (self-referencing for organizational structure)
  parentId          String?    @map("parent_id")
  parent            Department? @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children          Department[] @relation("DepartmentHierarchy")
  
  // Status & Metadata
  isActive          Boolean    @default(true) @map("is_active")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  
  // Relations
  users             User[]
  actionLogs        UserActionLog[]
  userRoles         UserRole[]
  
  @@map("departments")
  @@index([name])
  @@index([shortName])
  @@index([parentId])
}

// =============================================================================
// DOMAIN: USER ACTION LOG (Audit Trail)
// =============================================================================

model UserActionLog {
  id                String     @id @default(uuid())
  
  // Actor Information
  userId            String     @map("user_id")
  user              User       @relation("UserActions", fields: [userId], references: [id], onDelete: Cascade)
  
  // Action Details
  actionType        ActionType @map("action_type")
  actionDescription String?    @map("action_description")
  
  // Target Entity (optional - for actions on other entities)
  targetUserId      String?    @map("target_user_id")
  targetUser        User?      @relation("TargetUserActions", fields: [targetUserId], references: [id], onDelete: SetNull)
  
  targetDepartmentId String?   @map("target_department_id")
  targetDepartment  Department? @relation(fields: [targetDepartmentId], references: [id], onDelete: SetNull)
  
  // Generic target for other entities
  targetEntityType  String?    @map("target_entity_type")
  targetEntityId    String?    @map("target_entity_id")
  
  // Request Context
  ipAddress         String?    @map("ip_address")
  userAgent         String?    @map("user_agent")
  requestPath       String?    @map("request_path")
  requestMethod     String?    @map("request_method")
  
  // Additional Data (JSON for flexibility)
  metadata          Json?
  previousData      Json?      @map("previous_data")
  newData           Json?      @map("new_data")
  
  // Status
  isSuccess         Boolean    @default(true) @map("is_success")
  errorMessage      String?    @map("error_message")
  
  // Timestamp
  createdAt         DateTime   @default(now()) @map("created_at")
  
  @@map("user_action_logs")
  @@index([userId])
  @@index([actionType])
  @@index([targetUserId])
  @@index([targetDepartmentId])
  @@index([createdAt])
  @@index([isSuccess])
}

model OffSiteWork {
  id                    String      @id
  innerRefDocumentId    String?     @map("inner_ref_document_id")
  startDate             DateTime    @map("start_date")
  endDate               DateTime    @map("end_date")
  objective             String?     @map("objective")
  location              String?     @map("location")
  employeeList          Json?       @map("employee_list")
  posted_at             DateTime    @map("posted_at") @default(now())
  postedByUserId     String      @map("posted_by_user_id")
  postedByUser        User        @relation(fields: [postedByUserId], references: [id], onDelete: Cascade)
  updated_at            DateTime?   @map("updated_at") @updatedAt
  deleted_at            DateTime?   @map("deleted_at")
  originalFileId        String?     @map("original_file_id")

  originalFile          Files?      @relation(fields: [originalFileId], references: [id], onDelete: SetNull)
  
  expenseClaimOffSiteWorks ExpenseClaimOffSiteWork[]
  
  @@map("off_site_works")
  @@index([postedByUserId])
  @@index([originalFileId])
  @@index([startDate])
  @@index([endDate])
  @@index([deleted_at])
  @@index([posted_at])
}

model Files {
  id                    String     @id @default(uuid())
  fileName               String      @map("file_name")
  fileType               String?     @map("file_type")
  fileSize               Int?        @map("file_size")
  fileContent            Bytes?      @map("file_content")
  uploadedById          String      @map("uploaded_by_id")
  uploadedBy            User        @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  uploadedAt            DateTime?   @map("uploaded_at") @default(now())
  deletedAt             DateTime?   @map("deleted_at")
  
  offSiteWorks OffSiteWork[]
  
  @@map("files")
  @@index([uploadedById])
  @@index([deletedAt])
  @@index([uploadedAt])
}

enum ClaimDocumentStatus {
  DRAFT // Initial status when a claim is being prepared but not yet submitted for review
  PENDING // Status when a claim is created and awaiting review
  APPROVED // Status when a claim has been reviewed and approved by the relevant authority
  REJECTED // Status when a claim has been reviewed and rejected, often with feedback for the claimant
  CANCELLED // Status when a claim has been cancelled by the claimant or due to other reasons
}
model ExpenseClaim {
  id                     String     @id @default(uuid())
  expenseMonth           DateTime    @map("expense_month") // Represents the month for which expenses are claimed (e.g. 2024-01-01 for January 2024)
  userId                 String      @map("user_id")
  claimant               User        @relation("ExpenseClaimUser", fields: [userId], references: [id], onDelete: Cascade)
  claimantPositionAtSubmission String     @map("claimant_position_at_submission")

  /// Expected structure: JSON array of ISO-8601 date strings (e.g. "2024-01-15"),
  /// listing the specific calendar days within `forMonth` for which expenses are claimed.
  selectedDates          Json?      @map("selected_dates")
  countDates             Decimal?    @map("count_dates") // Represents the number of specific dates selected for the month, if applicable
  amount                 Decimal?    @map("amount")
  remark                 String?     @map("remark")

  createdById            String     @map("created_by_id")
  createdBy              User       @relation("ExpenseClaimCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt              DateTime   @default(now()) @map("created_at")
  status                 ClaimDocumentStatus @default(DRAFT)
  updatedAt              DateTime?  @map("updated_at") @updatedAt
  cancelledAt            DateTime?  @map("cancelled_at")

  monthlyRequestCollectionId       String?    @map("monthly_request_collection_id")
  monthlyRequestCollection         MonthlyRequestCollection? @relation(fields: [monthlyRequestCollectionId], references: [id], onDelete: SetNull)
  collectedAt            DateTime?   @map("collected_at")
  
  expenseClaimOffSiteWorks ExpenseClaimOffSiteWork[]
  
  @@map("expense_claims")
  @@index([userId])
  @@index([createdById])
  @@index([monthlyRequestCollectionId])
  @@index([expenseMonth])
  @@index([status])
  @@index([createdAt])
  @@index([userId, expenseMonth])
  @@index([status, expenseMonth])
}

model ExpenseClaimOffSiteWork {
  expenseClaimId String @map("expense_claim_id")
  offSiteWorkId  String @map("off_site_work_id")

  expenseClaim   ExpenseClaim @relation(fields: [expenseClaimId], references: [id], onDelete: Cascade)
  offSiteWork    OffSiteWork  @relation(fields: [offSiteWorkId], references: [id], onDelete: Cascade)

  @@id([expenseClaimId, offSiteWorkId])
  @@map("expense_claim_off_site_work")
  @@index([offSiteWorkId])
}

model MonthlyRequestCollection {
  id                 String     @id @default(uuid())
  collectorId        String     @map("collector_id")
  collector          User       @relation(fields: [collectorId], references: [id], onDelete: Cascade)
  collectForMonth       DateTime   @map("collect_for_month") // Represents the month for which data is being collected (e.g. 2024-01-01 for January 2024)
  countDates         Decimal?   @map("count_dates") // Represents the number of specific dates selected for the month, if applicable
  amount              Decimal?   @map("amount")

  status            ClaimDocumentStatus @default(DRAFT)
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime?  @map("updated_at") @updatedAt
  cancelledAt       DateTime?  @map("cancelled_at")
  
  expenseClaims ExpenseClaim[]
  
  @@map("monthly_request_collections")
  @@index([collectorId])
  @@index([collectForMonth])
  @@index([status])
  @@index([createdAt])
  @@index([collectorId, collectForMonth])
}

model Signature {
  id                String     @id @default(uuid())
  userId            String     @map("user_id")
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  signatureData     Bytes      @map("signature_data") // Binary data for the signature (e.g. image bytes)
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime?  @map("updated_at") @updatedAt
  deletedAt         DateTime?  @map("deleted_at")
  
  @@map("signatures")

  @@index([deletedAt])
  @@index([userId, deletedAt])
}

// =============================================================================
// DOMAIN: PERMISSION & AUTHORIZATION
// =============================================================================

/// Resource category for organizing permissions
enum PermissionResource {
  // Core resources
  USER
  DEPARTMENT
  ROLE
  PERMISSION
  
  // Business resources
  EXPENSE_CLAIM
  OFF_SITE_WORK
  MONTHLY_REQUEST
  SIGNATURE
  FILE
  
  // System resources
  ACTION_LOG
  SYSTEM
}

/// Actions that can be performed on resources
enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  LIST
  EXPORT
  IMPORT
  APPROVE
  REJECT
  SUBMIT
  CANCEL
  MANAGE  // Full control over the resource
}

/// Scope of permission (own items, department items, or all items)
enum PermissionScope {
  OWN         // Only own resources (e.g., own expense claims)
  DEPARTMENT  // Resources within user's department
  ALL         // All resources regardless of ownership
}

/// Permission model - Defines individual permissions
model Permission {
  id                String            @id @default(uuid())
  
  // Permission identification
  code              String            @unique // e.g., "expense-claim:create", "user:manage"
  name              String            // Human-readable name
  description       String?           // Detailed description
  
  // Permission categorization
  resource          PermissionResource
  action            PermissionAction
  scope             PermissionScope   @default(OWN)
  
  // Metadata
  isActive          Boolean           @default(true) @map("is_active")
  isSystem          Boolean           @default(false) @map("is_system") // System permissions cannot be deleted
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  rolePermissions   RolePermission[]
  
  @@map("permissions")
  @@index([resource])
  @@index([action])
  @@index([code])
  @@index([isActive])
}

/// Role model - Defines named roles that group permissions
model Role {
  id                String            @id @default(uuid())
  
  // Role identification
  code              String            @unique // e.g., "admin", "manager", "employee"
  name              String            // Human-readable name
  description       String?           // Role description
  
  // Role hierarchy (optional)
  level             Int               @default(0) // Higher level = more authority
  parentRoleId      String?           @map("parent_role_id")
  parentRole        Role?             @relation("RoleHierarchy", fields: [parentRoleId], references: [id], onDelete: SetNull)
  childRoles        Role[]            @relation("RoleHierarchy")
  
  // Metadata
  isActive          Boolean           @default(true) @map("is_active")
  isSystem          Boolean           @default(false) @map("is_system") // System roles cannot be deleted
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  
  // Relations
  userRoles         UserRole[]
  rolePermissions   RolePermission[]
  
  @@map("roles")
  @@index([code])
  @@index([level])
  @@index([isActive])
  @@index([parentRoleId])
}

/// UserRole - Junction table linking users to roles
/// Supports department-scoped role assignments
model UserRole {
  id                String            @id @default(uuid())
  
  // User and Role
  userId            String            @map("user_id")
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId            String            @map("role_id")
  role              Role              @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  // Department scope (optional - null means global assignment)
  departmentId      String?           @map("department_id")
  department        Department?       @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  // Assignment metadata
  assignedById      String?           @map("assigned_by_id")
  assignedAt        DateTime          @default(now()) @map("assigned_at")
  expiresAt         DateTime?         @map("expires_at") // Optional expiration for temporary roles
  
  // Status
  isActive          Boolean           @default(true) @map("is_active")
  
  @@unique([userId, roleId, departmentId])
  @@map("user_roles")
  @@index([userId])
  @@index([roleId])
  @@index([departmentId])
  @@index([isActive])
  @@index([expiresAt])
}

/// RolePermission - Junction table linking roles to permissions
model RolePermission {
  id                String            @id @default(uuid())
  
  roleId            String            @map("role_id")
  role              Role              @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId      String            @map("permission_id")
  permission        Permission        @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  // Granted metadata
  grantedById       String?           @map("granted_by_id")
  grantedAt         DateTime          @default(now()) @map("granted_at")
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
  @@index([roleId])
  @@index([permissionId])
}


